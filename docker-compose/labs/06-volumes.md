# Практическое задание 6. Докер-том.

> _Hint: Задание охватывает только тома Docker для Linux._

Хранение данных лучше выполнять вне контейнера. Идея заключаетсяв том, чтобы запускать, останавливать и удалять контейнеры без потери данных.

Существует два способа монтирования данных из вашего контейнера: `bind mounts` и `volumes`.

**A bind mount**. Он принимает путь хоста, например `/data`, и монтирует его внутри вашего контейнера, например. `/opt/app/data`. **A bind mount** хорош тем, что  позволяет подключаться напрямую к файловой системе хоста. Недостатком является то, что нужно указывать путь во время выполнения контейнера, а путь для монтирования может отличаться от хоста к хосту. При использовании привязки вам также придется выполнять резервное копирование, миграцию и т. д. с помощью инструмента вне экосистемы `Docker`.

**Том докера** — это место, где используется том с именем или без имени для хранения внешних данных. Обычно для этого используется драйвер тома, но можно получить путь подключения к хосту, используя драйвер локального тома по умолчанию.

## Bind mounts

Рассмотрим контейнер [Nginx](https://hub.docker.com/_/nginx/).
Сам по себе сервер бесполезен, если он не может получить доступ к нашему веб-контенту на хосте.

Создать сопоставление между хост-системой и контейнером с помощью команды `-v`:

```bash
docker run --name some-nginx -v /some/content:/usr/share/nginx/html:ro -d nginx
```
Это сопоставит все файлы, находящиеся в папке `/some/content` на хосте, с `/usr/share/nginx/html` в контейнере.

> Атрибут `:ro` делает том хоста доступным только для чтения, гарантируя, что контейнер не сможет редактировать файлы на хосте.

## Ход работы

- `git clone` этот репозиторий.
- Перейдите в каталог `labs/volumes/`, который содержит файл, который требуется использовать сервером Nginx: `index.html`.
- Изменить `/some/content` на локальный путь, это должен быть абсолютный путь, начиная с корня файловой системы (который в Linux — `/`). Использовать команду `pwd` (вывод пути рабочего каталога).
- Запустить контейнер с установленной привязкой к каталогу `labs/volume`. Это даст  работающий сервер `Nginx`, обслуживающий статические файлы... _Но на каком порту?_
- Запусть команду `docker ps`, чтобы узнать, есть ли какие-либо порты, перенаправленные с хоста.
- Разместить сайт на порт 8000.

<details>
<summary>Как это сделать?</summary>
  
Параметр `-p 8000:80` сопоставит порт 80 в контейнере с портом 8000 на хосте.

</details>

- Перейти на хост или IP-адрес в браузере, указав порт 8000.
- Остановите контейнер с помощью `docker stop <container_name>`.

## Volumes

Том — это объект внутри `Docker`, существует три способа их создания:

- Явноу создание, с помощью команды `docker volume create <volume_name>`.
- Создание именованного тома во время создания контейнера с помощью `docker container run -d -v DataVolume:/opt/app/data nginx`.
- Создание анонимного тома во время создания контейнера с помощью `docker container run -d -v /opt/app/data nginx`.

Создать том данных под названием `data:

```bash
docker volume create data
```
Docker создает том и выведет имя созданного тома.

Запустить `docker volume ls`:

```outputs
DRIVER              VOLUME NAME
local               data
```
В отличие от монтирования с привязкой, вы не указываете, где на хосте хранятся данные.

В API тома, как и во всех других API Docker, есть команда `inspect`, предоставляющая подробную информацию на низком уровне.

— запустите `docker volume inspect data`, чтобы увидеть, где данные хранятся на хосте.

```json
[
    {
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/data/_data",
        "Name": "data",
        "Options": {},
        "Scope": "local"
    }
]
```
Том данных смонтирован в `/var/lib/docker/volumes/data/_data` на хосте.


> **Примечание** Здесь не рассматриваются драйверы. Для получения дополнительной информации посмотрите [example](https://docs.docker.com/engine/admin/volumes/volumes/#use-a-volume-driver).

Использовать этот том данных во всех контейнерах. Подключить его к серверу `nginx` с помощью команды `docker container run --rm --name www -d -p 8080:80 -v data:/usr/share/nginx/html nginx`.

> **Примечание.** Если указанный том пуст, указываем путь к каталогу, содержащему данные базового образа, эти данные будут скопированы в том.

Просмотреть данные, хранящиеся в `/var/lib/docker/volumes/data/_data` на хосте:

```
sudo ls /var/lib/docker/volumes/data/_data/
```

Ожидаемый результат:

```
50x.html  index.html
```
Эти два файла взяты из образа Nginx и являются стандартными файлами веб-сервера.

### Монтирование нескольких контейнеров к тому

К одному и тому же тому с данными можно подключить несколько контейнеров.

Docker не обрабатывает блокировку файлов, поэтому приложения должны сами учитывать блокировку файлов.

Создать новую HTML-страницу не сервере nginx.

Создать контейнер Ubuntu, в котором том `data` прикреплен к `/tmp`, а затем создаём новый html-файл с помощью команды `echo`:

Запустите контейнер:

```
docker run -it --rm -v data:/tmp ubuntu bash
```

В контейнере запустить:

```
echo "<html><h1>hello world</h1></html>" > /tmp/hello.html
```

Убедиться, что файл был создан в контейнере:

```
ls /tmp
```

Ожидаемый результат:

```
hello.html  50x.html  index.html
```
Перейти на веб-страницу по адресу:: `http://<IP>:8080/hello.html`

## Очистка

Выйдите из вашего сервера Ubuntu и выполните `docker stop www`, чтобы остановить контейнер nginx.

Запустите `docker ps`, чтобы убедиться, что другие контейнеры не запущены.

```
docker ps
```

Ожидаемый результат:

```
CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS              PORTS                                                          NAMES
```
Том данных по-прежнему присутствует и будет там до тех пор, пока не удалитm его с помощью `docker volume rm data` или не выполните общую очистку всех неиспользуемых томов, запустив `docker volume prune`.

## Лайфхак

Флаг `-v` может как создать привязку, так и присваивает имя тому в зависимости от синтаксиса. Если первый аргумент начинается с / или ~/, создается привязка. Удалив эти символы, можно присвоить имя тому. Например:

- `-v /path:/path/in/container` монтирует каталог хоста, `/path` в `/path/in/container`
- `-v path:/path/in/container` создает том с именем path, не имеющий отношения к хосту.

### Обмен данными

Если требуется использовать том совместно или связать монтирование между двумя контейнерами, используется опция `--volumes-from` для второго контейнера. Параметр сопоставляет тома из исходного контейнера с запускаемым контейнером.


## Продвинутые команды докера

Прежде чем продолжить, воспользуйтесь документацией [Интерфейс командной строки Docker](https://docs.docker.com/engine/reference/commandline/cli/), чтобы проверить несколько команд:

- Пока отсоединенный контейнер работает, используйте команду `docker ps`, чтобы увидеть, какое имя Docker дал вашему контейнеру. **Эту команду  часто используют!**
- Пока отсоединенный контейнер  работает, просмотрите его журналы. Просмотреть его журналы и обновить браузер.
- Остановите отсоединенный контейнер и проверьте его остановку с помощью команды `ps`.
- Запустите его снова, подождите 10 секунд, и снова остановите его.
- Затем удалите этот контейнер из вашей системы.

> **ПРИМЕЧАНИЕ.** При запуске большинства команд Docker требуется указать только первые несколько символов идентификатора контейнера. Например, если контейнер имеет идентификатор `df4fd19392ba`, можно остановить его с помощью docker stop df4. Можно использовать нелепые имена для контейнеров, которые Docker предоставляет контейнерам по умолчанию.

Узнать больше  по совместному использованию данных через контейнеры можно по линку [Digital Oceans](https://www.digitalocean.com/community/tutorials/how-to-share-data-between-docker-containers).

